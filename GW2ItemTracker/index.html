<!DOCTYPE html>
<html lang="en">
	<head>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
		<style>
			img{
			height: 32px;
			width: 32px;
			cursor: pointer;
			}
			
			.tabButton{
				width: 150px;
				margin: 0;
				background-color:#FFF;
				color: #777;
				border: solid 1px #777;
				cursor: pointer;
			}
			
			.selectedTab{
				background-color:#ABC;
				color: #000;
			}
			
			.inputRow{
			margin: 10px 0;
			}
			
			.tableRow{
			margin: 10px 0;
			display: flex;
			border: solid 1px #DDD;
			min-width: 900px;
			}
			
			.tableCell{
			margin: 10px 10px;
			text-align: center;
			width: 100px;
			min-width: 100px;
			max-width: 100px;
			overflow:hidden;
			white-space:nowrap;
			}
			
			.headRow{
			font-weight:bold;
			cursor: default;
			}
			
			.headCell{
			margin: 10px 10px;
			text-align: center;
			width: 100px;
			min-width: 100px;
			max-width: 100px;
			white-space: wrap;
			}
			
			
			.headImg{
			height: 23px;
			width: 32px;
			padding-top: 8px;
			cursor: default;
			}
			
			.targetAchieved{
			background-color: #7A7;
			}
			
			.sellRow{
			border: solid 3px green;
			}
			
			.inputArea{
			min-width: 777px;
			}
			
			.outputArea{
			
			}
			
			.hidden{
			display:none;
			}
			
		</style>
		<title>GW2 TP Tracker</title>
		<script>
			//A2B4C26D-0D28-8B4A-86B8-BF5FC014082AB25CA636-6D16-4053-8299-ACC149928F09
			const storageKey = 'GW2TPT_IP';
			const apiStorageKey = 'GW2TPT_API';
			const IdPrices = JSON.parse(localStorage.getItem(storageKey)) || [];
			const itemPrices = [];
			let materials = [];
			const tabCostWatcher = 'tabCostWatcher';
			const tabMaterialStorage = 'tabMaterialStorage';
			const tabs = [tabCostWatcher, tabMaterialStorage];
			let activeTab = 'tabCostWatcher';
			
			const colHeaders = {
				id: 'ID',
				name: 'Name',
				icon: 'https://wiki.guildwars2.com/images/thumb/d/db/Guild_Wars_2_logo.svg/1200px-Guild_Wars_2_logo.svg.png',
				buyTarget: 'Buy Target',
				sellTarget: 'Sell Target',
				vendorValue: 'Vendor Value (G)',
				buyQuantity: 'Buys qty',
				buyPrice: 'Current Top Buyer (G)',
				sellQuantity: 'Sells qty',
				sellPrice: 'Current Top Seller (G)',
				storage: 'In Storage',
				totalVendorValue: 'Total Vendor Value (G)',
				totalTPValue: 'Total TP Value (G)'
			};
			let apiKey = null;
			
			function getApi(){
				const api = document.getElementById('api');
				if(api && api.value){
					localStorage.setItem(apiStorageKey, api.value);
					apiKey = api.value;
					return apiKey;
				}
				
				apiKey = localStorage.getItem(apiStorageKey);
				return apiKey;
			}
			
			function addIdPrice(id, buyTarget, sellTarget){
				id = Number(id);
				buyTarget = Number(buyTarget);
				sellTarget = Number(sellTarget);
				if(IdPrices.some(x => x.id === id)){
					if(confirm('Item already exists in list. Update price?')){
						IdPrices.find(x => x.id === id).buyTarget = buyTarget;
						IdPrices.find(x => x.id === id).sellTarget = sellTarget;
						localStorage.setItem(storageKey, JSON.stringify(IdPrices));
					}
					return;
				}
				
				IdPrices.push({id: id, buyTarget: buyTarget, sellTarget: sellTarget});
				localStorage.setItem(storageKey, JSON.stringify(IdPrices));
			}
			
			function removeItem(id){
				const index = IdPrices.map(x => x.id).indexOf(id);
				if(index < 0){return;}
				IdPrices.splice(index,1);
				localStorage.setItem(storageKey, JSON.stringify(IdPrices));
				getData();
			}
			
			function addItem(){
				const id = document.getElementById('id').value;
				const sellTarget = document.getElementById('sellTarget').value;
				const buyTarget = document.getElementById('buyTarget').value;
				addIdPrice(Number(id), Number(buyTarget), Number(sellTarget));
				
				document.getElementById('id').value = '';
				document.getElementById('sellTarget').value = '';
				document.getElementById('buyTarget').value = '';
				
				getData();
			}
			
			function addItemPrice(item, price, buyTarget, sellTarget){
				if(!item?.id || !price?.id){return;}
				if(item?.id !== price?.id){
					console.warn(`Item Mismatch: ${item.id} !== ${price.id}`);
					return;
				}
				
				const owned = materials ? materials.find(x => x.id === item.id) : null;
				
				itemPrices.push({
					id: item.id,
					name: item.name,
					icon: item.icon,
					buyTarget: buyTarget,
					sellTarget: sellTarget,
					vendorValue: item.vendor_value/10000,
					buyQuantity: price.buys.quantity,
					buyPrice: price.buys.unit_price/10000,
					sellQuantity: price.sells.quantity,
					sellPrice: price.sells.unit_price/10000,
					storage: owned?.count || 0,
					totalVendorValue: item.vendor_value * owned?.count / 10000,
					totalTPValue: price.buys.unit_price * owned?.count / 10000
				});
			}
			
			function addText(parent, text, isHead, highlight){
				const cell = document.createElement('div');
				cell.title = text;
				cell.className = isHead ? 'headCell':'tableCell';
				
				if(highlight){
					cell.classList.add('targetAchieved');
				}
				
				const temp = document.createTextNode(text);
				cell.appendChild(temp);
				
				parent.appendChild(cell);
			}
			
			function buildItemPriceDiv(parent, itemPrice, isHead){
				if(!parent){return;}
				const div = document.createElement('div');
				div.className = 'tableRow';
				
				const img = document.createElement('img');
				img.src = itemPrice.icon;
				img.alt = itemPrice.id;
				
				img.addEventListener('click', (event)=>{
					const id  = Number(event.target.alt);
					const item = itemPrices.find(x => x.id === id);
					
					document.getElementById('id').value = item.id;
					document.getElementById('buyTarget').value = item.buyTarget;
					document.getElementById('sellTarget').value = item.sellTarget;
				})
				
				const shouldBuy = activeTab === tabCostWatcher && !isHead && itemPrice.sellPrice < itemPrice.buyTarget;
				const shouldSell = activeTab === tabCostWatcher && !isHead && itemPrice.buyPrice > itemPrice.sellTarget;
				
				div.appendChild(img);
				addText(div, itemPrice.name, isHead, 0);
				addText(div, itemPrice.id, isHead, 0);
				addText(div, itemPrice.buyPrice, isHead, shouldSell);
				if(activeTab === tabCostWatcher){addText(div, itemPrice.sellTarget, isHead, shouldSell);}
				if(activeTab === tabCostWatcher){addText(div, itemPrice.sellPrice, isHead, shouldBuy);}
				if(activeTab === tabCostWatcher){addText(div, itemPrice.buyTarget, isHead, shouldBuy);}
				if(activeTab === tabMaterialStorage){addText(div, itemPrice.vendorValue, isHead, shouldSell);}
				addText(div, itemPrice.storage, isHead, activeTab === tabCostWatcher && !isHead && itemPrice.storage > 950);
				if(activeTab === tabMaterialStorage){addText(div, itemPrice.totalTPValue, isHead);}
				if(activeTab === tabMaterialStorage){addText(div, itemPrice.totalVendorValue, isHead);}
				
				if(isHead){
					const spacer = document.createElement('div');
					spacer.style.width = '66px';
					div.appendChild(spacer);
					parent.appendChild(div);
					img.classList.add('headImg');
					div.classList.add('headRow');
					return;
				}
				
				if(activeTab === tabCostWatcher){
					const btn = document.createElement('button');
					btn.appendChild(document.createTextNode('X'));
					btn.addEventListener('click', () => removeItem(itemPrice.id));
					div.appendChild(btn);
				}
				
				parent.appendChild(div);
			}
			
			async function getCostData(outputDiv){
				const ids = IdPrices.map(x => x.id).filter(x => x > 0);
				if(ids.length === 0){return;}
				
				const payload = ids.join(',');
				
				//https://wiki.guildwars2.com/wiki/API:2
				const getPrices = `https://api.guildwars2.com/v2/commerce/prices?ids=${payload}`;
				const getItems = `https://api.guildwars2.com/v2/items?ids=${payload}`;
				
				const authToken=getApi();
				const getStorage = `https://api.guildwars2.com/v2/account/materials?v=2021-07-24T00%3A00%3A00Z&access_token=${authToken}`;
				
				const items = await (await fetch(getItems)).json() || [];
				const prices = await (await fetch(getPrices)).json() || [];
				if(!!authToken){
					const tempMaterials = await (await fetch(getStorage)).json() || [];
					materials = Array.isArray(tempMaterials) ? tempMaterials : [];
				}
				
				IdPrices.forEach(temp => {
					const item = items.find(x => x.id === temp.id);
					const price = prices.find(x => x.id === temp.id);
					addItemPrice(item, price, temp.buyTarget || 0, temp.sellTarget || 0);
				})
				
				itemPrices.sort((a,b) => a.name.localeCompare(b.name));
				buildItemPriceDiv(outputDiv, colHeaders, true);
				itemPrices.forEach(x => buildItemPriceDiv(outputDiv, x, false));
			}
			
			async function getMaterialStorageData(outputDiv){
				const authToken=getApi();
				const getStorage = `https://api.guildwars2.com/v2/account/materials?v=2021-07-24T00%3A00%3A00Z&access_token=${authToken}`;
				if(!authToken){
					alert('No API token');
					return;
				}
				
				const tempMaterials = await (await fetch(getStorage)).json() || [];
				materials = Array.isArray(tempMaterials) ? tempMaterials : [];
				
				if(materials.length < 1){return;}
				
				const limit = Number(document.getElementById('materialThreshold').value);
				materials = materials.filter(x => x.count >= limit);
				if(materials.length < 1){return;}
				
				const payload = materials.map(x => x.id).join(',');
				const getPrices = `https://api.guildwars2.com/v2/commerce/prices?ids=${payload}`;
				const getItems = `https://api.guildwars2.com/v2/items?ids=${payload}`;
				
				const items = await (await fetch(getItems)).json() || [];
				const prices = await (await fetch(getPrices)).json() || [];
				
				materials.forEach(temp => {
					const item = items.find(x => x.id === temp.id);
					const price = prices.find(x => x.id === temp.id);
					addItemPrice(item, price, 0, 0);
				})
				
				itemPrices.sort((a,b) => a.name.localeCompare(b.name));
				buildItemPriceDiv(outputDiv, colHeaders, true);
				itemPrices.forEach(x => buildItemPriceDiv(outputDiv, x, false));
			}
			
			function getData(){
				const outputDiv = document.getElementById('output');
				while(outputDiv?.firstChild){outputDiv.removeChild(outputDiv.firstChild);}
				itemPrices.length = 0;

				switch(activeTab){
					case tabCostWatcher: {
						getCostData(outputDiv);
						return;
					}
					case tabMaterialStorage:{
						getMaterialStorageData(outputDiv);
						return;
					}
				}
			}
			
			function setTab(sender, input){
				const selected = document.getElementsByClassName('selectedTab');
				Array.from(selected).forEach(x => x.classList.remove('selectedTab'));
				sender.classList.add('selectedTab');

				tabs.forEach(x => document.getElementById(x).classList.add('hidden'));
				document.getElementById(input)?.classList.remove('hidden');
				activeTab = input;
				getData();
			}
			
			function exportStorage(){
				var textToSave = JSON.stringify(IdPrices);
				var textToSaveAsBlob = new Blob([textToSave], {type: "text/plain"});
				var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
				
				var downloadLink = document.createElement("a");
				downloadLink.download = 'GW2TPT export.txt';
				downloadLink.innerHTML = "Download File";
				downloadLink.href = textToSaveAsURL;
				downloadLink.onclick = function () {
					document.body.removeChild(event.target);
				};
				downloadLink.style.display = "none";
				document.body.appendChild(downloadLink);
				downloadLink.click();
			}
			
			function importStorage(sender){
				const file = sender.files[0];
				
				file.text().then((content) => {
					localStorage.setItem(storageKey, content);
					window.location.reload();
				});
			}
		</script>
	</head>
	<body>
		<div id="input" class="inputArea">
			<div class="inputRow">
				<label for='api'>API Key (for material storage):</label>
				<input id="api" style="width:600px" 
				onchange = "getApi();" 
				onkeypress = "this.onchange();"
				oninput = "this.onchange();"/>
			</div>
			<div id="tabSelector">
				<button class='tabButton selectedTab' id="tabTP" onclick='setTab(this, "tabCostWatcher")'>Cost Watcher</button>
				<button class='tabButton' id="tabStorage" onclick='setTab(this, "tabMaterialStorage")'>Full Material Storage</button>
			</div>
			<hr/>
			<div id="tabContent">
				<div id="tabCostWatcher">
					<div class="inputRow">
						<button id='export' onclick='exportStorage()'>Export</button>
						||
						<label for='upload'>Import:</label>
						<input type='file' id='upload' name='upload' accept='txt' onchange='importStorage(this)'/>
					</div>
					<div class="inputRow">
						<label for='id'>ID:</label><input type="number" id="id" min="0" max="900000" />
						<label for='buyTarget'>Buy Target(G):</label><input type="number" id="buyTarget" min="0" max="10000" />
						<label for='sellTarget'>Sell Target(G):</label><input type="number" id="sellTarget" min="0" max="10000" />
						<button onclick="addItem()">Add Item</button>
					</div>
				</div>
				<div id="tabMaterialStorage">
					<label for='materialThreshold'>Material Storage Limit:</label><input type="number" id="materialThreshold" min="200" max="2000" value="1000" />
					<button onclick="getData()">Refresh</button>
				</div>
			</div>
			<div>
				
			</div>
		</div>
		<hr/>
		<div id="output" class='outputArea'></div>
		<script>
			document.getElementById('api').value = localStorage.getItem('GW2TPT_API');
			getData();
		</script>
	</body>
</html>		